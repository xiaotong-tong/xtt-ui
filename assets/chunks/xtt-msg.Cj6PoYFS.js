var W=Object.defineProperty;var _=Object.getPrototypeOf;var ee=Reflect.get;var te=(t,e,r)=>e in t?W(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var y=(t,e,r)=>(te(t,typeof e!="symbol"?e+"":e,r),r),D=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var q=(t,e,r)=>(D(t,e,"read from private field"),r?r.call(t):e.get(t)),E=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)};var N=(t,e,r)=>(D(t,e,"access private method"),r),B=(t,e,r)=>ee(_(t),r,e);import{x as re}from"./reflect.u-rLhaQE.js";import"./base.C5bbslE4.js";var ne=`<div id="body" part="body" class="msg-body"></div>
`;const H=new CSSStyleSheet;H.replaceSync(":host {display:block;width:100%;}.heimu {background-color:currentColor;}.heimu:hover {background-color:transparent;}");var v,J;const j=class j{static doTextMatchList(e,r){var s;const n=e.match(new RegExp("(?<=-->>|\\()[\\s\\S]*?(?=-->>|\\)$)","g"));if(!n)return[];const a=N(s=j,v,J).call(s,n,"-->>","\\(","\\)").map(c=>c.trim());return r?a:Promise.all(a.map(p.doReplaceToText))}};v=new WeakSet,J=function(e,r,n,a){let s=[],c=0,u=[];return e.forEach(i=>{~i.search(new RegExp(n+"|"+a))?(c=c+(i.match(new RegExp(n,"g"))||[]).length-(i.match(new RegExp(a,"g"))||[]).length,u.push(i),c===0&&(s.push(u.join(r)),u=[])):c?u.push(i):s.push(i)}),s},E(j,v);let o=j;const m=(t,e)=>{if(t=Number(t),Number.isNaN(t))return e!=null&&e.NaNFormat?0:NaN;if(t>Number.MAX_SAFE_INTEGER)return Number.MAX_SAFE_INTEGER;if(t<Number.MIN_SAFE_INTEGER)return Number.MIN_SAFE_INTEGER;if(e!=null&&e.int)switch(e.intFormatType){case"ceil":t=Math.ceil(t);break;case"floor":t=Math.floor(t);break;case"round":t=Math.round(t);break;default:t=Math.trunc(t);break}return t},X=(t,e)=>{if(t>e){const r=t;t=e,e=r}return t=m(t,{NaNFormat:!0,int:!0,intFormatType:"ceil"}),e=m(e,{NaNFormat:!0,int:!0,intFormatType:"floor"}),[t,e]},P=(t,e)=>(t===void 0&&e===void 0&&(t=1,e=100),e===void 0&&(e=t,t=1),isNaN(t)||isNaN(e)?NaN:([t,e]=X(t,e),t+Math.floor(Math.random()*(e-t+1)))),ae=t=>{if(!(t!=null&&t.length))return[];const e=[...t];for(let r=e.length-1;r>0;r--){const n=P(0,r),a=e[n];e[n]=e[r],e[r]=a}return e},se=(t,e,r)=>{if(t===void 0&&(t=0),e===void 0&&(e=t,t=0),r===0)return[];if(t=m(t,{NaNFormat:!0,int:!0,intFormatType:"ceil"}),e=m(e,{NaNFormat:!0,int:!0,intFormatType:"floor"}),t===e)return[t];r===void 0&&(r=e<t?-1:1),r=m(r,{NaNFormat:!0,int:!0,intFormatType:"trunc"});const n=~~((e-t)/r)+1,a=new Array(n);for(let s=0;s<n;s++)a[s]=s*r+t;return a},z=(t,e,r)=>{if(typeof e!="function"){console.error(e+" is not a function");return}const{thisArg:n,asyncIterator:a}=r||{};let s=!1;const c=i=>{if(i[Symbol.iterator]||i[Symbol.asyncIterator]){s=!0;let l=0;if(a||i[Symbol.asyncIterator])return new Promise((h,S)=>{(async()=>{const k=[];for await(const R of i)k.push(new Promise(Z=>{Z(e.call(n,R,l,i))})),l++;Promise.all(k).then(R=>{h(R)}).catch(R=>{S(R)})})()});{const h=[];for(const S of i){const k=e.call(n,S,l,i);l++,h.push(k)}return h}}};let u=c(t);return s||t instanceof Object&&(u=c(Object.entries(t))),u},M=(t,e,r)=>{if((typeof e>"u"||Number.isNaN(Number(e)))&&(e=10),t=m(t,{NaNFormat:!0}),r===void 0&&(r=!0),r){const n=e===16?"0x":e===8?"0o":e===2?"0b":"";return t>=0?n+t.toString(e):"-"+n+Math.abs(t).toString(e)}return t.toString(e)},ce=(...t)=>t!=null&&t.length?t.flat(1/0).reduce((e,r)=>e+r):0,Y=(t,e,r)=>{if(t===void 0&&(t=1),e===void 0&&(e=10),[t,e]=X(t,e),t===e)return[e];let n;if(typeof r=="number"?n=r:typeof r=="object"?n=r.count??e-t+1:n=e-t+1,n<=0)return[];if((r==null?void 0:r.unique)??!1)if(n>(e-t)/2){let s=se(t,e);return s=ae(s),n===void 0?s:s.slice(0,n)}else{const s=new Set;for(;s.size<n;)s.add(P(t,e));return Array.from(s)}else{const s=[];for(let c=0;c<n;c++)s.push(P(t,e));return s}};function ie(t,e){!Array.isArray(t)&&t instanceof Object&&(e=Object.values(t),t=Object.keys(t));let r=0;if(Array.isArray(t)&&Array.isArray(e)){e.length>t.length?e.length=t.length:t.length=e.length;const n=P(1,ce(e));for(let a=0;a<t.length;a++)if(r+=e[a],n<=r)return t[a]}return t[0]}const oe=t=>{if(!(t!=null&&t.length))return"";let e="";for(let r=t.length-1;r>=0;r--)e+=t[r];return e},ue=t=>{if(t===void 0||t===""||Number.isNaN(t))return NaN;if(!Number.isNaN(Number(t)))return Number(t);if(!~t.search(/\d/))return NaN;const e=a=>a.replace(/\D/g,"");let r=1;t.startsWith("-")&&(r=-1);const n=t.indexOf(".");return~n?r*parseFloat(`${e(t.slice(0,n))}.${e(t.slice(n+1))}`):r*parseInt(e(t))},I=(t,e)=>{if(!t)return"";const{separator:r="",base:n=16}=e||{};return z(t,a=>M(a.codePointAt(0),n)).join(r)},le=(t,e,r)=>{if(typeof t!="string")return!1;if(typeof e=="string")return t.startsWith(e,r);if(e instanceof RegExp){const n=t.slice(r);return e.source.startsWith("^")?e.test(n):new RegExp("^"+e.source,e.flags).test(n)}return!1},fe=(t,e,r)=>{if(typeof t!="string")return!1;if(typeof e=="string")return t.endsWith(e,r);if(e instanceof RegExp){const n=t.slice(0,r);return e.source.endsWith("$")?e.test(n):new RegExp(e.source+"$",e.flags).test(n)}return!1},pe=(t,e,r)=>{if(typeof t!="string"||e===void 0||(r===void 0&&(r=1),r===0))return"";if(le(t,e)){if(r<=1)return"";r-=1}const n=new RegExp(`.+?(?=${typeof e=="string"?e:e.source})`,"g"),a=t.match(n);return a===null?"":(r<=-a.length&&(r=a.length===1?1:-a.length+1),a.slice(0,r).join(""))},he=(t,e,r)=>{if(typeof t!="string"||e===void 0)return"";if(r===void 0&&(r=1),r===0)return t;const n=typeof e=="string"?e:e.source,a=new RegExp(`(?<=(^|${n})).*?(${n}|$)`,"g"),s=t.match(a);return s===null?"":(r>=s.length&&(r=s.length-1),r<=-s.length&&(r=-s.length+1),s.slice(r).join(""))},de=(t,e)=>{if(typeof t!="string"||e===void 0)return"";const r=e[0],n=e[1],a=typeof r=="string"?r:r.source,s=typeof n=="string"?n:n.source;let c=t.match(new RegExp(`${a}((?:[\\s\\S](?<!${a}))*?)${s}`));return c?c[1]:(c=t.match(new RegExp(`${s}((?:[\\s\\S](?<!${s}))*?)${a}`)),c?c[1]:"")},T=new Map;T.set(["文本-反转文本","text-reverse"],async t=>{const[e]=await o.doTextMatchList(t);return e?oe(e):""});T.set(["文本-取文本左","text-getLeft"],async t=>{const[e,r,n]=await o.doTextMatchList(t);return e?r?pe(e,r,n):e:""});T.set(["文本-取文本右","text-getRight"],async t=>{const[e,r,n]=await o.doTextMatchList(t);return e?r?he(e,r,n):e:""});T.set(["文本-取中间","text-getContent"],async t=>{const[e,r,n]=await o.doTextMatchList(t);return e?de(e,[r,n]):""});T.set(["文本-替换","text-replace"],async t=>{let[e,r,n]=await o.doTextMatchList(t);return e?!r||!n?e:(r=r.split(/[,，]/),n=n.split(/[,，]/),e.replaceAll(new RegExp(r.map(a=>"("+a+")").join("|"),"g"),(a,...s)=>n[s.findIndex(c=>c!==void 0)]||"")):""});T.set(["文本-取数字","text-getNumber"],async t=>{const[e]=await o.doTextMatchList(t);if(!e)return"";const r=ue(e);return Number.isNaN(r)?"":r});class g{static getVariable(e){let r=this.variableMap[e];if(r===void 0)throw"没有变量"+e+"哦";if(r.next){let n=r.next();return n.done?"已经获取完了哦~再重新赋值一个吧！":n.value}return r}static setVariable(e,r){return typeof r=="string"&&r.includes("\\u")&&(r=r.replace(/\\u[0123456789abcdef]{4,}/g,function(n){return String.fromCharCode("0x"+n.substr(2,4))})),this.variableMap[e]=r,""}}y(g,"variableMap",{nyaLang:"nya,喵,~,!,‍,ニャー,にゃ,‎"});const b=new Map;function ge(t=Date.now(),e){const r=new Date(t),n=r.getFullYear(),a=(r.getMonth()+1).toString().padStart(2,"0"),s=r.getDate().toString().padStart(2,"0"),c=r.getHours().toString().padStart(2,"0"),u=r.getMinutes().toString().padStart(2,"0"),i=r.getSeconds().toString().padStart(2,"0"),l=r.getDay(),h=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];return e?e==="all"?`${n}-${a}-${s} ${c}:${u}:${i} ${h[l]}`:e.replace(/=(?:[年月日时分秒]|星期)=/g,S=>{switch(S){case"=年=":return n;case"=月=":return a;case"=日=":return s;case"=时=":return c;case"=分=":return u;case"=秒=":return i;case"=星期=":return h[l]}}):`${n}-${a}-${s} ${c}:${u}:${i}`}b.set(["当前时间","now"],async t=>{const[e]=await o.doTextMatchList(t);return ge(Date.now(),e)});b.set(["返回","return"],async t=>{let[e,r]=await o.doTextMatchList(t);return e&&(r==="0"?p.backText=e:(p.backTextPrevLevel.value=e,p.backTextPrevLevel.isCurrentLevel=!1)),""});b.set(["变量","variable"],async t=>{const[e,r]=await o.doTextMatchList(t);return e?r?g.setVariable(e,r):g.getVariable(e):""});b.set(["JSON"],async t=>{const[e,r]=await o.doTextMatchList(t);if(!e)return"";let a=JSON.parse(e);for(const s of r.matchAll(new RegExp("(?<=\\[)[\\s\\S]+?(?=\\])","g"))){if(a===void 0)return"";a=a==null?void 0:a[Array.isArray(s)?s[0]:s]}return Array.isArray(a)||a instanceof Object?JSON.stringify(a):a});b.set(["循环","forin"],async t=>{const[e,r,n]=await o.doTextMatchList(t,!0);if(!e)return"";const[a,s]=await Promise.all([p.doReplaceToText(e),p.doReplaceToText(r)]),c=a.split(new RegExp(s));let u=1;for(const i of c)g.setVariable("循环变量值",i),g.setVariable("循环变量次数",u),await p.doReplaceToText(n),u++;return""});b.set(["循环变量","forVariable"],async t=>{const[e]=await o.doTextMatchList(t);return e?e==="值"?g.getVariable("循环变量值"):e==="次数"?g.getVariable("循环变量次数"):"":""});const d=new Map;d.set(["选择","choice"],async t=>{let[e,...r]=await o.doTextMatchList(t,!0);if(!e)return"";if(e=await p.doReplaceToText(e),isNaN(+e)){let n="?<"+e+">",a="";for await(const s of r){const c=await p.doReplaceToText(s);c.startsWith(n)&&(a=c)}return a?a.substring(n.length):""}else{let n=parseInt(e);if(n>0)n=n-1,n>=r.length&&(n=r.length-1);else{if(n===0)return"";n<0&&(n=n+r.length,n<0&&(n=0))}return p.doReplaceToText(r[n])}});d.set(["判断","judge","if"],async t=>{const[e,r="",n=""]=await o.doTextMatchList(t,!0);if(!e)return"";const a=await p.doReplaceToText(e);try{return Function("return "+a)()?p.doReplaceToText(r):p.doReplaceToText(n)}catch{throw`请将${t}改为正确的判断公式`}});d.set(["计算","calc"],async t=>{const[e]=await o.doTextMatchList(t);if(!e)return"";try{return Function("return "+e)()}catch{throw`请将${t}改为正确的计算公式`}});d.set(["随机数","random","r"],async t=>{let[e,r,n]=await o.doTextMatchList(t);return n=parseInt(n),isNaN(n)&&(n=1),Y(e||1,r||100,n).join(",")});d.set(["权重随机数","weidgeRandom","WR"],async t=>{const[e,r]=await o.doTextMatchList(t);if(!e)return"";const n=e.split(/[,，]/);let a=[];if(r)a=r.split(/[,，]/).map(s=>parseInt(s));else for(let s=0;s<n.length-1;s++)a.push(1);return ie(n,a)});d.set(["非重随机数"],async t=>{const[e,r,n]=await o.doTextMatchList(t),a=Y(e||1,r||10,{unique:!0});return n?(g.setVariable(n,a[Symbol.iterator]()),""):a});d.set(["八进制"],async t=>{const[e]=await o.doTextMatchList(t)||[];if(!e)return"";const r=Number(e);return Number.isNaN(r)?I(e,{base:8}):M(r,8)});d.set(["十六进制"],async t=>{const[e]=await o.doTextMatchList(t)||[];if(!e)return"";const r=Number(e);return Number.isNaN(r)?I(e,{base:16}):M(r,16)});d.set(["二进制"],async t=>{const[e]=await o.doTextMatchList(t)||[];if(!e)return"";const r=Number(e);return Number.isNaN(r)?I(e,{base:2}):M(r,2)});d.set(["十进制"],async t=>{const[e]=await o.doTextMatchList(t)||[];if(!e)return"";const r=Number(e);return Number.isNaN(r)?I(e,{base:10}):M(r,10)});const $=new Map;function K(t){return/^<[\s\S]+>$/.test(t)}$.set(["文本-注音","text-ruby"],async t=>{const[e,r]=await o.doTextMatchList(t);return!e&&!r?"":`<ruby>${e}<rp>(</rp><rt>${r}</rt><rp>)</rp></ruby>`});function ye(t,e){return K(t)?e?(t=t.replaceAll("'",'"'),t.includes("style=")?t.replace(/style="([\s\S]*?)"(?![;,])/,`style="$1 color: ${e};"`):t.replace(/^<([^>]+?)>/,`<$1 style="color: ${e};">`)):t:e?`<span style="color: ${e};" >${t}</span>`:`<span>${t}</span>`}$.set(["文本-文字颜色","text-color"],async t=>{const[e,r]=await o.doTextMatchList(t);return e?ye(e,r):""});function Te(t){return K(t)?(t=t.replaceAll("'",'"'),t.includes("class=")?t.replace(/class="([^"]*?)"/,'class="$1 heimu"'):t.replace(/^<([^>]+?)>/,'<$1 class="heimu">')):`<span class="heimu">${t}</span>`}$.set(["文本-黑幕","text-mask"],async t=>{const[e]=await o.doTextMatchList(t);return e?Te(e):""});$.set(["换行","break"],()=>"<br />");$.set(["空格","space"],()=>"&nbsp;");const G=new Map;G.set(["喵语"],async t=>{const[e]=await o.doTextMatchList(t);if(!e)return"";const r=g.getVariable("nyaLang").split(",");return z(e,n=>M(n.codePointAt(0),8,!1).replace(/\d/g,a=>r[a])).join("‌")+"."});G.set(["解喵语"],async t=>{let[e]=await o.doTextMatchList(t);if(!e)return"";const r=g.getVariable("nyaLang").split(",");if(e=e.substring(0,e.length-1),!new RegExp(`^(${r.join("|")}|‌)+$`).test(e))throw"遇到了不认识的喵语呢。";return e.split("‌").map(a=>String.fromCodePoint("0o"+a.replace(new RegExp(r.join("|"),"g"),s=>r.indexOf(s)))).join("")});const L={};$.forEach((t,e)=>{e.forEach(r=>{L[r]=t})});G.forEach((t,e)=>{e.forEach(r=>{L[r]=t})});d.forEach((t,e)=>{e.forEach(r=>{L[r]=t})});b.forEach((t,e)=>{e.forEach(r=>{L[r]=t})});T.forEach((t,e)=>{e.forEach(r=>{L[r]=t})});var C,Q;const f=class f{static doReplace(e){return f.doReplaceToText(e)}static formatToParts(e){return f.getParts(e).formatParts}static async replaceAsync(e,r,n){const a=[];e.replace(r,(c,...u)=>{const i=n(c,...u);a.push(i)});const s=await Promise.all(a);return e.replace(r,()=>s.shift())}static getParts(e,r=!1){let n=e.match(/[()]|[^()]+/g),a=[],s=[],c=0,u=0,i=0;for(let l=1;l<n.length;l++)if(n[l]==="("){const h=fe(n[l-1],/!\[[^\]]+\]$/);if(c===0&&!h)continue;c===0&&(u=l),c++}else if(n[l]===")"){if(c<=0)continue;if(c===1){const h=(n[u-1].match(/!\[[^\]]+\]$/)[0]??"")+n.slice(u,l+1).join("");s.push(h),n[u-1]=n[u-1].replace(/!\[[^\]]+\]$/,""),a.push(n.slice(i,u).join("")),a.push(h),i=l+1}c--}return i<n.length&&a.push(n.slice(i,n.length).join("")),a=a.filter(l=>l!=="").map(l=>l.startsWith("![")&&l.endsWith(")")&&/.+!\[[^\]]+\]\([\s\S]*\)/.test(l)?{value:l,children:f.getParts(l.replace(/.+?\(|\)$/,""),!0)}:l),r?a:{matches:s,formatParts:a}}static async doReplaceToText(e){if(/!\[[^\]]+\]\([\s\S]*\)/.test(e)){const{matches:r}=f.getParts(e);for(const n of r){const a=async s=>{var u;const c=await N(u=f,C,Q).call(u,s);if(f.backTextPrevLevel.isCurrentLevel===!0){const i=f.backTextPrevLevel.value;return f.backTextPrevLevel={},i}else f.backTextPrevLevel.isCurrentLevel===!1&&(f.backTextPrevLevel.isCurrentLevel=!0);return c};e=await f.replaceAsync(e,n,a),f.backText&&(e=f.backText,f.backText="")}}return e}};C=new WeakSet,Q=function(e){const r=e.match(/^!\[([^\]]+)\]/);return f.MatchTextList[r[1]]?f.MatchTextList[r[1]](r.input):r.input},E(f,C),y(f,"backText"),y(f,"backTextPrevLevel",{}),y(f,"MatchTextList",L);let p=f;const V=[{promise:Promise.resolve(),resolve:Promise.resolve()}],be=t=>{const e={};return e.promise=new Promise(async r=>{e.resolve=r;try{await V[V.length-1].promise}finally{try{const n=await p.doReplace(t);r(n)}catch(n){r(n)}}}),V.push(e),e.promise};var x,A,F,U;const w=class w extends re{constructor(){super();E(this,x);E(this,F)}connectedCallback(){super.connectedCallback(),N(this,x,A).call(this)}_reflectElementAdded(){N(this,x,A).call(this)}_reflectElementRemoved(){N(this,x,A).call(this)}};x=new WeakSet,A=async function(){const r=this.textContent;r&&(q(this,F,U).innerHTML=await be(r))},F=new WeakSet,U=function(){return this.shadowRoot.getElementById("body")},y(w,"templateContent",ne),y(w,"stylesContent",[...B(w,w,"stylesContent"),H]);let O=w;customElements.define("xtt-msg",O);
